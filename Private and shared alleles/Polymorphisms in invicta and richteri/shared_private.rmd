---
title: "Comparing ILS and introgression scenarios using SNPs"
author: "Rodrigo Pracana, QMUL"
date: "09/11/2021"
output: html_document
---

```{r setup, include=FALSE, cache = FALSE}


make_sci <- function(x) {
    sprintf("%.1fx10^{%d}",
          x/10^floor(log10(abs(x))),
          floor(log10(abs(x))))
}

pretty_number_inner <- function(x) {
  if (is.na(x)) {
    x <- NA
  } else if (x == 0) {
    x <- as.character(x)
  } else if (x < 1e-4) {
    x <- as.character(make_sci(x))
  } else if  (x < 1e-2) {
     x <- as.character(round(x, 4))
  } else if (x < 1e4) {
     x <- as.character(round(x, 2))
  } else {
     x <- as.character(make_sci(x))
  }
  return(x)
}

pretty_numbers <- function(x) {
  sapply(x, pretty_number_inner)
}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)


library(tidyverse)
library(patchwork)
library(broom)

dir.create(recursive = T, "results/fig")

```

```{r}

snp_freq <- read.csv("results/snp_frequencies.csv")

snp_freq$CONSEQUENCE[is.na(snp_freq$CONSEQUENCE)] <- "not protein-coding"

```

## Introduction

We are studying `r nrow(snp_freq)` SNP sites.

```{r}

snp_freq %>%
  group_by(region) %>% count

snp_freq %>%
  group_by(region, CONSEQUENCE) %>%
  summarise(n = n()) %>%
  mutate(percent = round(100 * n / sum(n)))

```

Within a species, the allele frequency of SNPs in the Sb samples and SB samples should be highly correlated, except in the supergene. This is seen in _S. invicta_:

```{r}

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous", "not protein-coding")) %>%
  ggplot() +
    geom_point(aes(x = daf_invicta_bb, y = daf_invicta_lb), alpha = 0.5) +
    facet_grid(cols = vars(CONSEQUENCE), rows = vars(region)) +
  theme_bw()

```

It is also seen in _S. richteri_:

```{r}

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous", "not protein-coding")) %>%
  ggplot() +
    geom_point(aes(x = daf_richteri_bb, y = daf_richteri_lb), alpha = 0.5) +
    facet_grid(cols = vars(CONSEQUENCE), rows = vars(region)) +
  theme_bw()

```

When we compare between species, we see the following:

```{r}

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous", "not protein-coding")) %>%
  ggplot() +
    geom_point(aes(x = daf_invicta_bb, y = daf_richteri_bb), alpha = 0.5) +
    facet_grid(cols = vars(CONSEQUENCE), rows = vars(region)) +
  theme_bw()

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous", "not protein-coding")) %>%
  ggplot() +
    geom_point(aes(x = daf_invicta_lb, y = daf_richteri_lb), alpha = 0.5) +
    facet_grid(cols = vars(CONSEQUENCE), rows = vars(region)) +
  theme_bw()


```

## Private to SB

```{r}

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "not protein-coding")) %>%
  pivot_longer(c(private_to_invicta_bb, private_to_richteri_bb)) %>%
  group_by(region, CONSEQUENCE, name) %>%
  summarize(number = sum(value),
            percentage = round(100* sum(value)/n()),
            n = n())

```

```{r}

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous")) %>%
   pivot_longer(c(private_to_invicta_bb, private_to_richteri_bb)) %>%
   group_by(region, CONSEQUENCE, name, TXID) %>%
  summarize(number = sum(value)) %>%
  pivot_wider(names_from = name, values_from = number) %>%
  ggplot() +
    geom_point(aes(x = private_to_invicta_bb, y =private_to_richteri_bb), alpha = 0.5) +
    facet_grid(cols = vars(CONSEQUENCE), rows = vars(region)) +
  theme_bw() +
    coord_fixed(xlim = c(0, 20), ylim = c(0,20))

```

## Shared between SB and the two Sb

```{r}

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "not protein-coding")) %>%
  pivot_longer(c(shared_lb_invicta_bb, shared_lb_richteri_bb)) %>%
  group_by(region, CONSEQUENCE, name) %>%
  summarize(number = sum(value),
            percentage = round(100* sum(value)/n()),
            n = n())

```

```{r}

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous")) %>%
   pivot_longer(c(shared_lb_invicta_bb, shared_lb_richteri_bb)) %>%
   group_by(region, CONSEQUENCE, name, TXID) %>%
  summarize(number = sum(value)) %>%
  pivot_wider(names_from = name, values_from = number) %>%
  ggplot() +
    geom_point(aes(x = shared_lb_invicta_bb, y =shared_lb_richteri_bb), alpha = 0.5) +
    facet_grid(cols = vars(CONSEQUENCE), rows = vars(region)) +
  theme_bw() +
    coord_fixed(xlim = c(0, 20), ylim = c(0,20))

```

## Private to each lineage

```{r}
private_alleles <- function(freq_matrix, pop) {
  pop_freq   <- freq_matrix[, pop, drop = FALSE]
  other_freq <- freq_matrix[, !colnames(freq_matrix) %in% pop, drop = FALSE]

  # Present in population 1 and no other population
  #    The sum of frequencies will be greater than 0 if the allele is present
  #  in at least one of the other populations
  (apply(pop_freq, 1, sum) > 0) & (apply(other_freq, 1, sum) == 0)

}

snp_freq$private_to_richteri <- snp_freq$daf_invicta_bb == 0 & snp_freq$daf_invicta_lb == 0 &
(snp_freq$daf_richteri_bb > 0 | snp_freq$daf_richteri_lb > 0 )

snp_freq$private_to_invicta <- snp_freq$daf_richteri_bb == 0 & snp_freq$daf_richteri_lb == 0 &
(snp_freq$daf_invicta_bb > 0 | snp_freq$daf_invicta_lb > 0 )

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "not protein-coding")) %>%
  pivot_longer(c(private_to_invicta, private_to_richteri)) %>%
  group_by(region, CONSEQUENCE, name) %>%
  summarize(number = sum(value),
            percentage = round(100* sum(value)/n()),
            n = n())

snp_freq$private_to_richteri_bb <-
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_lb == 0 &
  snp_freq$daf_richteri_bb > 0

snp_freq$private_to_richteri_lb <-
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_richteri_lb > 0


snp_freq$private_to_invicta_bb <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_lb == 0 &
  snp_freq$daf_invicta_bb > 0

snp_freq$private_to_invicta_lb <-
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_richteri_lb == 0 &
  snp_freq$daf_invicta_lb > 0


snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "not protein-coding")) %>%
  pivot_longer(c(private_to_richteri_bb, private_to_richteri_lb,
                 private_to_invicta_bb, private_to_invicta_lb)) %>%
  group_by(region, CONSEQUENCE, name) %>%
  summarize(number = sum(value),
            percentage = round(100* sum(value)/n()),
            n = n())

```

## Fixed differences between SB and Sb

```{r}

snp_freq$fixed_difference <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb == 1 &
  snp_freq$daf_richteri_lb == 1

snp_freq %>%
  group_by(region) %>%
  summarize(number = sum(fixed_difference),
            percentage = round(100* sum(fixed_difference)/n()),
            n = n())

snp_freq %>%
  group_by(region, CONSEQUENCE) %>%
  summarize(number = sum(fixed_difference),
            percentage = round(100* sum(fixed_difference)/n()),
            n = n())

```

## Private alleles present in the Sb of both species

```{r}

snp_freq$in_both_Sb <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb > 0 &
  snp_freq$daf_richteri_lb > 0

snp_freq %>%
  group_by(region, CONSEQUENCE) %>%
  summarize(number = sum(in_both_Sb),
            percentage = round(100* sum(in_both_Sb)/n()),
            n = n())

```

## Private alleles present in the SB of both species

As expected, there are very few of these (they occur because of incomplete lineage sorting):

```{r}

snp_freq$in_both_Sb <-
  snp_freq$daf_richteri_bb > 0 &
  snp_freq$daf_invicta_bb > 0 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_lb == 0

snp_freq %>%
  group_by(region, CONSEQUENCE) %>%
  summarize(number = sum(in_both_Sb),
            percentage = round(100* sum(in_both_Sb)/n()),
            n = n())

```

```{r}


snp_freq %>% filter(region == "supergene") %>%
  ggplot(aes(x = daf_invicta_bb, y = daf_richteri_bb)) +
  geom_point(alpha = 0.5) +
  facet_grid(cols=vars(in_both_Sb), rows = vars(CONSEQUENCE))


```

## Alleles private to Sb, but not necessarily present in both species

```{r}

snp_freq$private_to_Sb <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb == 0 &
  (snp_freq$daf_invicta_lb > 0 | snp_freq$daf_richteri_lb > 0)

snp_freq %>%
  group_by(region, CONSEQUENCE) %>%
  summarize(number = sum(private_to_Sb),
            percentage = round(100* sum(private_to_Sb)/n()),
            n = n())

```

## Alleles present in Sb (but not necessarily private to Sb)

```{r}

snp_freq$present_in_Sb <-
  (snp_freq$daf_invicta_lb > 0 | snp_freq$daf_richteri_lb > 0)

snp_freq %>%
  group_by(region, CONSEQUENCE) %>%
  summarize(number = sum(present_in_Sb),
            percentage = round(100* sum(present_in_Sb)/n()),
            n = n())

```


## Alleles present in SB (but not necessarily private to SB)

```{r}

snp_freq$present_in_SB <-
  (snp_freq$daf_invicta_bb > 0 | snp_freq$daf_richteri_bb > 0)

snp_freq %>%
  group_by(region, CONSEQUENCE) %>%
  summarize(number = sum(present_in_SB),
            percentage = round(100* sum(present_in_SB)/n()),
            n = n())

```

## Private but not fixed per lineage

```{r}

snp_freq$polymorphic_invicta_bb_only <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb > 0 & snp_freq$daf_invicta_bb < 1 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_lb == 0

snp_freq$polymorphic_invicta_lb_only <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb > 0 & snp_freq$daf_invicta_lb < 1 &
  snp_freq$daf_richteri_lb == 0

snp_freq$polymorphic_richteri_bb_only <-
  snp_freq$daf_richteri_bb > 0 & snp_freq$daf_richteri_bb < 1 &
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_lb == 0

snp_freq$polymorphic_richteri_lb_only <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_lb > 0 & snp_freq$daf_richteri_lb < 1

snp_freq$polymorphic_richteri_only <-
  (snp_freq$daf_richteri_bb > 0 | snp_freq$daf_richteri_lb > 0) &
  !(snp_freq$daf_richteri_bb == 1 & snp_freq$daf_richteri_lb == 1) &
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb == 0

snp_freq$polymorphic_invicta_only <-
  (snp_freq$daf_invicta_bb > 0 | snp_freq$daf_invicta_lb > 0) &
  !(snp_freq$daf_invicta_bb == 1 & snp_freq$daf_invicta_lb == 1) &
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_richteri_lb == 0

snp_freq$polymorphic_bb_only <-
  snp_freq$daf_richteri_bb > 0 & snp_freq$daf_richteri_bb < 1 &
  snp_freq$daf_invicta_bb > 0 & snp_freq$daf_invicta_bb < 1 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_lb == 0

snp_freq$polymorphic_lb_only <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb > 0 & snp_freq$daf_invicta_lb < 1 &
  snp_freq$daf_richteri_lb > 0 & snp_freq$daf_richteri_lb < 1

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous", "not protein-coding")) %>%
  pivot_longer(c(polymorphic_invicta_bb_only,
                 polymorphic_invicta_lb_only,
                 polymorphic_richteri_bb_only,
                 polymorphic_richteri_lb_only,
                 polymorphic_richteri_only,
                 polymorphic_invicta_only,
                 polymorphic_bb_only,
                 polymorphic_lb_only)) %>%
  group_by(region, name, CONSEQUENCE) %>%
  summarize(number = sum(value)) %>%
  pivot_wider(names_from = CONSEQUENCE, values_from = number)

```

## Private and fixed per lineage

```{r}

snp_freq$fixed_invicta_bb_only <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb == 1 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_lb == 0

snp_freq$fixed_invicta_lb_only <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb == 1 &
  snp_freq$daf_richteri_lb == 0

snp_freq$fixed_richteri_bb_only <-
  snp_freq$daf_richteri_bb == 1 &
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_lb == 0

snp_freq$fixed_richteri_lb_only <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_lb == 1

snp_freq$fixed_richteri_only <-
  snp_freq$daf_richteri_bb == 1 &
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_lb == 1

snp_freq$fixed_invicta_only <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb == 1 &
  snp_freq$daf_invicta_lb == 1 &
  snp_freq$daf_richteri_lb == 0

snp_freq$fixed_bb_only <-
  snp_freq$daf_richteri_bb == 1 &
  snp_freq$daf_invicta_bb == 1 &
  snp_freq$daf_invicta_lb == 0 &
  snp_freq$daf_richteri_lb == 0

snp_freq$fixed_lb_only <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_invicta_lb == 1 &
  snp_freq$daf_richteri_lb == 1

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous", "not protein-coding")) %>%
  pivot_longer(c(fixed_invicta_bb_only,
                 fixed_invicta_lb_only,
                 fixed_richteri_bb_only,
                 fixed_richteri_lb_only,
                 fixed_richteri_only,
                 fixed_invicta_only,
                 fixed_bb_only,
                 fixed_lb_only)) %>%
  group_by(region, name, CONSEQUENCE) %>%
  summarize(number = sum(value)) %>%
  pivot_wider(names_from = CONSEQUENCE, values_from = number)


```

## Shared between Sb and each of the SB species

```{r}

# Present in Sb and in S. invicta SB
snp_freq$pesent_sb_invicta_bb <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb > 0 &
  (snp_freq$daf_invicta_lb > 0 | snp_freq$daf_richteri_lb > 0)

# Present in Sb and in S. richteri SB
snp_freq$pesent_sb_richteri_bb <-
  snp_freq$daf_richteri_bb > 0 &
  snp_freq$daf_invicta_bb == 0 &
  (snp_freq$daf_invicta_lb > 0 | snp_freq$daf_richteri_lb > 0)

# Present in both species
snp_freq$pesent_both_species <-
  (snp_freq$daf_richteri_bb > 0 | snp_freq$daf_richteri_lb > 0) &
  (snp_freq$daf_invicta_bb > 0 | snp_freq$daf_invicta_lb > 0)

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous", "not protein-coding")) %>%
  pivot_longer(c(pesent_sb_invicta_bb,
                 pesent_sb_richteri_bb,
                 pesent_both_species)) %>%
  group_by(region, name, CONSEQUENCE) %>%
  summarize(number = sum(value)) %>%
  pivot_wider(names_from = CONSEQUENCE, values_from = number) %>%
  mutate(total = synonymous + nonsynonymous + `not protein-coding`)

```

## Shared between Sb and each of the SB species

```{r}

# Fixed in Sb and present in S. invicta SB
snp_freq$fixed_sb_present_invicta_bb <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb > 0 &
  (snp_freq$daf_invicta_lb == 1 | snp_freq$daf_richteri_lb == 1)

# Present in Sb and in S. richteri SB
snp_freq$fixed_sb_present_richteri_bb <-
  snp_freq$daf_richteri_bb > 0 &
  snp_freq$daf_invicta_bb == 0 &
  (snp_freq$daf_invicta_lb == 1 | snp_freq$daf_richteri_lb == 1)

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous", "not protein-coding")) %>%
  pivot_longer(c(fixed_sb_present_invicta_bb,
                 fixed_sb_present_richteri_bb)) %>%
  group_by(region, name, CONSEQUENCE) %>%
  summarize(number = sum(value)) %>%
  pivot_wider(names_from = CONSEQUENCE, values_from = number)

```
## Shared between Sb and each of the SB species

```{r}

# Fixed in Sb and Fixed in S. invicta SB
snp_freq$fixed_sb_fixed_invicta_bb <-
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_bb == 1 &
  (snp_freq$daf_invicta_lb == 1 | snp_freq$daf_richteri_lb == 1)

# Fixed in Sb and Fixed in S. richteri SB
snp_freq$fixed_sb_fixed_richteri_bb <-
  snp_freq$daf_richteri_bb == 1 &
  snp_freq$daf_invicta_bb == 0 &
  (snp_freq$daf_invicta_lb == 1 | snp_freq$daf_richteri_lb == 1)

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous", "not protein-coding")) %>%
  pivot_longer(c(fixed_sb_fixed_invicta_bb,
                 fixed_sb_fixed_richteri_bb)) %>%
  group_by(region, name, CONSEQUENCE) %>%
  summarize(number = sum(value)) %>%
  pivot_wider(names_from = CONSEQUENCE, values_from = number)

```


## Present in all populations


```{r}

# Present in all populations
snp_freq$present_in_all <-
  snp_freq$daf_richteri_bb > 0 &
  snp_freq$daf_invicta_bb > 0 &
  snp_freq$daf_invicta_lb > 0 &
  snp_freq$daf_richteri_lb > 0

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous", "not protein-coding")) %>%
  pivot_longer(present_in_all) %>%
  group_by(region, name, CONSEQUENCE) %>%
  summarize(number = sum(value)) %>%
  pivot_wider(names_from = CONSEQUENCE, values_from = number)

```

## Deleterious load per species

### Alleles private to each

```{r}

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous")) %>%
  pivot_longer(c(private_to_richteri_bb, private_to_richteri_lb,
                 private_to_invicta_bb, private_to_invicta_lb)) %>%
  group_by(region, CONSEQUENCE, name) %>%
  summarize(number = sum(value),
            percentage = round(100* sum(value)/n()),
            n = n())

```

### Alleles private to Sb and fixed in each species

```{r}

snp_freq$private_to_Sb_and_fixed_invicta <-
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_invicta_lb == 1

snp_freq$private_to_Sb_and_fixed_richteri <-
  snp_freq$daf_invicta_bb == 0 &
  snp_freq$daf_richteri_bb == 0 &
  snp_freq$daf_richteri_lb == 1

snp_freq %>%
  filter(CONSEQUENCE %in% c("synonymous", "nonsynonymous")) %>%
  pivot_longer(c(private_to_Sb_and_fixed_invicta, private_to_Sb_and_fixed_richteri)) %>%
  group_by(region, name, CONSEQUENCE) %>%
  summarize(number = sum(value),
            percentage = round(100* sum(value)/n()),
            n = n())

```
